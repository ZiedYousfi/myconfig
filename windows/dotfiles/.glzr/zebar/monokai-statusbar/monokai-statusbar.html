<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="./monokai-statusbar.css" />
    <script src="https://unpkg.com/@babel/standalone@7.25.6/babel.min.js"></script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect } from "https://esm.sh/react@19.2.4";
      import { createRoot } from "https://esm.sh/react-dom@19.2.4/client";
      import * as zebar from "https://esm.sh/zebar@3.0";

      createRoot(document.getElementById("root")).render(<App />);

      const providers = zebar.createProviderGroup({
        glazewm: { type: "glazewm" },
        cpu: { type: "cpu", refreshInterval: 1000 },
        memory: { type: "memory", refreshInterval: 1000 },
        battery: { type: "battery", refreshInterval: 10000 },
        audio: { type: "audio" },
        network: { type: "network", refreshInterval: 2000 },
        date: { type: "date", formatting: "dd/MM T" },
      });

      const WORKSPACES = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10"];

      function App() {
        const [output, setOutput] = useState(providers.outputMap);
        const [volume, setVolume] = useState(
          output.audio?.defaultPlaybackDevice?.volume || 50,
        );
        const [showAllWorkspaces, setShowAllWorkspaces] = useState(false);

        useEffect(() => {
          providers.onOutput(() => setOutput(providers.outputMap));
        }, []);

        useEffect(() => {
          if (output.audio?.defaultPlaybackDevice?.volume != null) {
            setVolume(output.audio.defaultPlaybackDevice.volume);
          }
        }, [output.audio]);

        function getVolumeIcon(vol) {
          if (vol === 0) return "nf-fa-volume_off";
          if (vol < 33) return "nf-fa-volume_down";
          return "nf-fa-volume_up";
        }

        function getBatteryIcon(pct, charging) {
          if (charging) return "nf-fa-bolt";
          if (pct > 90) return "nf-fa-battery_full";
          if (pct > 60) return "nf-fa-battery_three_quarters";
          if (pct > 40) return "nf-fa-battery_half";
          if (pct > 20) return "nf-fa-battery_quarter";
          return "nf-fa-battery_empty";
        }

        // Get current workspaces info
        const currentWorkspaces = output.glazewm?.currentWorkspaces || [];
        const workspaceMap = {};
        currentWorkspaces.forEach((ws) => {
          workspaceMap[ws.name] = ws;
        });

        const focusedWorkspace = currentWorkspaces.find((ws) => ws.hasFocus);
        const focusedWorkspaceName = focusedWorkspace?.name;
        const focusedIndex = focusedWorkspaceName
          ? WORKSPACES.indexOf(focusedWorkspaceName)
          : 0;

        const visibleWorkspaces = (() => {
          if (showAllWorkspaces) return WORKSPACES;
          const safeIndex = focusedIndex >= 0 ? focusedIndex : 0;
          let start = Math.max(0, safeIndex - 1);
          let end = start + 3;
          if (end > WORKSPACES.length) {
            end = WORKSPACES.length;
            start = Math.max(0, end - 3);
          }
          return WORKSPACES.slice(start, end);
        })();

        // Get focused window title
        const focusedWindow = output.glazewm?.focusedContainer;
        const windowTitle = focusedWindow?.title || "";
        const truncatedTitle =
          windowTitle.length > 50
            ? windowTitle.substring(0, 47) + "..."
            : windowTitle;

        return (
          <div className="app">
            <div className="left">
              {output.glazewm && (
                <>
                  <button
                    className="keyboard-toggle"
                    onClick={() => output.glazewm.runCommand("shell-exec osk")}
                    title="Open Accessibility Keyboard"
                  >
                    <i className="nf nf-md-keyboard"></i>
                  </button>

                  <div className="workspaces">
                    {visibleWorkspaces.map((wsName) => {
                      const ws = workspaceMap[wsName];
                      const isFocused = ws?.hasFocus || false;
                      const isDisplayed = ws?.isDisplayed || false;
                      const hasWindows = ws?.children?.length > 0 || false;

                      return (
                        <button
                          className={`workspace ${isFocused ? "focused" : ""} ${isDisplayed ? "displayed" : ""} ${hasWindows ? "occupied" : ""}`}
                          onClick={() =>
                            output.glazewm.runCommand(
                              `focus --workspace ${wsName}`,
                            )
                          }
                          key={wsName}
                        >
                          {wsName}
                        </button>
                      );
                    })}
                  </div>

                  <div className="workspace-controls">
                    <button
                      className={`workspace-toggle ${showAllWorkspaces ? "active" : ""}`}
                      onClick={() => setShowAllWorkspaces((prev) => !prev)}
                      title={
                        showAllWorkspaces
                          ? "Show fewer workspaces"
                          : "Show all workspaces"
                      }
                    >
                      <i
                        className={`nf ${showAllWorkspaces ? "nf-fa-minus" : "nf-fa-plus"}`}
                      ></i>
                    </button>
                  </div>

                  <span className="chevron">
                    <i className="nf nf-oct-chevron_right"></i>
                  </span>

                  <div className="front-app">{truncatedTitle}</div>
                </>
              )}
            </div>

            <div className="center">
              <div className="clock">
                <i className="nf nf-fa-clock"></i>
                <span>{output.date?.formatted}</span>
              </div>
            </div>

            <div className="right">
              {output.cpu && (
                <div className="stat cpu">
                  <i className="nf nf-oct-cpu icon"></i>
                  <span className="value">{Math.round(output.cpu.usage)}%</span>
                </div>
              )}

              {output.memory && (
                <div className="stat memory">
                  <i className="nf nf-fae-chip icon"></i>
                  <span className="value">
                    {Math.round(output.memory.usage)}%
                  </span>
                </div>
              )}

              {output.battery && (
                <div className="stat battery">
                  <i
                    className={`nf ${getBatteryIcon(output.battery.chargePercent, output.battery.isCharging)} icon`}
                  ></i>
                  <span className="value">
                    {Math.round(output.battery.chargePercent)}%
                  </span>
                </div>
              )}

              {output.audio && (
                <div className="stat volume">
                  <button
                    className="volume-toggle"
                    onClick={() => {
                      const newVol = volume > 0 ? 0 : 50;
                      output.audio.setVolume?.(newVol);
                      setVolume(newVol);
                    }}
                  >
                    <i className={`nf ${getVolumeIcon(volume)}`}></i>
                  </button>
                  <span className="value">{Math.round(volume)}%</span>
                </div>
              )}

              {output.glazewm && (
                <button
                  className="tiling-direction"
                  onClick={() =>
                    output.glazewm.runCommand("toggle-tiling-direction")
                  }
                  title="Toggle Tiling Direction"
                >
                  <i
                    className={`nf ${output.glazewm.tilingDirection === "horizontal" ? "nf-md-arrow_left_right" : "nf-md-arrow_up_down"}`}
                  ></i>
                </button>
              )}
            </div>
          </div>
        );
      }
    </script>
  </body>
</html>
